@startuml BloodHero Complete Donation Flow - QR Scanning & Verification

actor "Donor" as donor
participant "MyAppointmentsActivity" as donorUI
participant "QRCodeGenerator" as qrGen
participant "LocalBroadcastManager" as broadcast

actor "Admin" as admin
participant "QRScannerActivity" as scannerUI
participant "BedManagementActivity" as bedUI
participant "AdminAppointmentsActivity" as adminUI

participant "AppointmentRepository" as apptRepo
participant "DonationRepository" as donationRepo
participant "UserRepository" as userRepo
participant "BloodHeroDatabaseHelper" as dbHelper
participant "SQLiteDatabase" as db

== Donor Arrives at Center ==
donor -> donorUI : Opens MyAppointments
donorUI -> apptRepo : getAppointmentsByUserId(userId)
apptRepo -> dbHelper : getAppointmentsByUserId(id)
dbHelper -> db : SELECT * FROM appointments WHERE user_id=?
db --> dbHelper : Cursor
dbHelper --> apptRepo : List<Appointment>
apptRepo --> donorUI : appointments
donorUI -> qrGen : generateQRCode(appointmentId)
qrGen --> donorUI : QR Code Bitmap
donorUI --> donor : Display appointment with QR code

== Admin Scans Donor QR Code ==
admin -> scannerUI : Opens QR Scanner
scannerUI --> admin : Camera ready
donor -> scannerUI : Shows QR code
scannerUI -> scannerUI : Decode QR (appointmentId)

scannerUI -> apptRepo : getAppointmentById(appointmentId)
apptRepo -> dbHelper : getAppointmentById(id)
dbHelper -> db : SELECT * FROM appointments WHERE id=?
db --> dbHelper : Appointment data
dbHelper --> apptRepo : Appointment
apptRepo --> scannerUI : appointment

scannerUI -> userRepo : getUserById(userId)
userRepo -> dbHelper : getUserById(id)
dbHelper -> db : SELECT * FROM users WHERE id=?
db --> dbHelper : User data
dbHelper --> userRepo : User
userRepo --> scannerUI : user

scannerUI --> admin : Show donor details

admin -> scannerUI : Confirms check-in
scannerUI -> apptRepo : updateStatus(appointmentId, CHECKED_IN)
apptRepo -> dbHelper : updateAppointmentStatus(id, CHECKED_IN)
dbHelper -> db : UPDATE appointments SET status='CHECKED_IN',\nchecked_in_at=TIMESTAMP
db --> dbHelper : rowsAffected
dbHelper --> apptRepo : success
apptRepo --> scannerUI : true

scannerUI -> broadcast : sendBroadcast(APPOINTMENT_UPDATED)
broadcast -> donorUI : onReceive(appointmentId)
donorUI -> apptRepo : getAppointmentById(id)
apptRepo --> donorUI : updated appointment
donorUI --> donor : Status changed to CHECKED_IN

scannerUI --> admin : Check-in successful

== Admin Assigns Bed ==
admin -> bedUI : Opens Bed Management
bedUI -> apptRepo : getAppointmentsByStatus(CHECKED_IN)
apptRepo -> dbHelper : getAppointmentsByStatus(CHECKED_IN)
dbHelper -> db : SELECT * FROM appointments WHERE status='CHECKED_IN'
db --> dbHelper : Cursor
dbHelper --> apptRepo : List<Appointment>
apptRepo --> bedUI : checked-in appointments
bedUI --> admin : Display available beds and waiting donors

admin -> bedUI : Assigns donor to Bed 3
bedUI -> apptRepo : assignToBed(appointmentId, 3)
apptRepo -> dbHelper : assignAppointmentToBed(id, 3)
dbHelper -> db : UPDATE appointments SET bed_number=3
db --> dbHelper : rowsAffected
dbHelper --> apptRepo : success
apptRepo --> bedUI : true

bedUI -> broadcast : sendBroadcast(APPOINTMENT_UPDATED)
broadcast -> donorUI : onReceive(appointmentId)
donorUI --> donor : Assigned to Bed 3

bedUI --> admin : Bed assigned successfully

note over donor, admin
  Donor completes blood donation
  (Physical donation process)
end note

== Admin Generates Verification Code ==
admin -> adminUI : Clicks "Generate Code" for donor
adminUI -> adminUI : Generate random 6-digit code
adminUI -> apptRepo : setPendingVerification(appointmentId, code)
apptRepo -> dbHelper : setAppointmentPendingVerification(id, code)
dbHelper -> db : UPDATE appointments SET\nstatus='PENDING_VERIFICATION',\nverification_code=?
db --> dbHelper : rowsAffected
dbHelper --> apptRepo : success
apptRepo --> adminUI : true

adminUI -> broadcast : sendBroadcast(APPOINTMENT_UPDATED)
broadcast -> donorUI : onReceive(appointmentId)
donorUI --> donor : Status: PENDING_VERIFICATION\nEnter verification code

adminUI --> admin : Code generated, shown to donor

== Donor Enters Verification Code ==
admin -> donor : Tells verification code
donor -> donorUI : Enters code in dialog
donorUI -> apptRepo : getAppointmentById(appointmentId)
apptRepo --> donorUI : appointment with verification_code
donorUI -> donorUI : Validate code matches

alt Code is correct
  donorUI -> donorUI : Create Donation object
  note right
  new Donation(
      UUID.randomUUID(),
      userId,
      campaignId,
      location,
      date,
      bloodType,
      50,
      "COMPLETED"
  )
  end note

  donorUI -> donationRepo : saveDonation(donation)
  donationRepo -> dbHelper : insertDonation(donation)
  dbHelper -> db : INSERT INTO donations VALUES(...)
  db --> dbHelper : rowId
  dbHelper --> donationRepo : success
  donationRepo --> donorUI : true

  donorUI -> apptRepo : updateStatus(appointmentId, COMPLETED)
  apptRepo -> dbHelper : updateAppointmentStatus(id, COMPLETED)
  dbHelper -> db : UPDATE appointments SET status='COMPLETED'
  db --> dbHelper : rowsAffected
  dbHelper --> apptRepo : success
  apptRepo --> donorUI : true

  donorUI -> userRepo : incrementDonations(userId, 50)
  userRepo -> dbHelper : incrementDonations(id, 50)
  dbHelper -> db : UPDATE users SET\ntotal_points=total_points+50,\ntotal_donations=total_donations+1,\nlast_donation_date=TIMESTAMP
  db --> dbHelper : rowsAffected
  dbHelper --> userRepo : success
  userRepo --> donorUI : void

  donorUI -> broadcast : sendBroadcast(APPOINTMENT_UPDATED)
  broadcast -> adminUI : onReceive(appointmentId)
  adminUI -> bedUI : onReceive(appointmentId)
  bedUI --> admin : Bed 3 released (auto)

  donorUI -> donorUI : Reload currentUser from DB
  donorUI --> donor : Donation Complete!\nEarned 50 points\nTotal donations updated

else Code is incorrect
  donorUI --> donor : Invalid code, try again
end

note over donor, db
  Complete flow ensures:
  - Real-time status updates via LocalBroadcastManager
  - QR code for secure check-in
  - Bed management for tracking
  - Verification code prevents unauthorized completions
  - Single database update atomicity
  - No duplicate donation counting
  - Automatic UI synchronization across all admin screens
end note

@enduml